<%- if @import.has_duplicate_keys -%>
  <h2>Duplicate Keys</h2>
  <div class="section">
    <p>There were some records in your dataset with duplicate keys.  You can
    flag records for deletion or manually edit new keys which have been
    automatically generated.</p>

    <!-- FIXME --!>
    <%- @import.dataset do |ds| -%>
      <%- primary_key = @import.primary_key_sym -%>
      <%- ds = ds.filter(~{:dup_key_count => nil}).order(primary_key, :dup_key_count) -%>
      <%- last_key = ds.last[primary_key] -%>
      <form>
        <table class="list">
          <thead>
            <tr>
              <th style="border: 1px gray; border-style: solid solid none solid;">New</th>
              <th colspan="<%= @import.field_names.length %>" style="border: 1px gray; border-style: solid none;">Current Values</th>
              <th style="border: 1px gray; border-style: solid solid none solid;">Remove</th>
            </tr>
            <tr>
              <th style="border-color: gray; border-width: 0 1px 2px 1px; border-style: none solid solid solid;">Key</th>
              <%- @import.field_names.each do |name| -%>
                <th><%= name %></th>
              <%- end -%>
              <th style="border-color: gray; border-width: 0 1px 2px 1px; border-style: none solid solid solid;">Row</th>
            </tr>
          </thead>
          <tbody>
            <%- ds.each_with_index do |row, i| -%>
              <tr<%= ' class="alt"' if i % 2 == 1 %> style="border: 1px gray; border-style: none solid;">
                <td style="border-right: 1px solid gray;">
                  <input type="text" style="width: 50px" value="<%= row[:dup_key_count] > 1 ? last_key = last_key.next : row[primary_key] %>" />
                </td>
                <%- @import.field_names.each do |name| -%>
                  <td><%= row[name.to_sym] %></td>
                <%- end -%>
                <td style="text-align: center; border-left: 1px solid gray;"><input type="checkbox" /></td>
              </tr>
            <%- end -%>
          </tbody>
        </table>
      </form>
    <%- end -%>
  </div>
<%- end -%>
