<%- @breadcrumbs = [@project, @resource] -%>
<%- add_javascript("jquery.tooltip.min.js", "jquery-ui.min.js", 'jquery.dataTables.min.js') -%>
<%- add_stylesheet('jquery-ui.css', 'dataTables.css') -%>
<h2>Fields</h2>
<table id="fields" class="dataTable" style="clear: both;">
  <thead>
    <tr>
      <th>Field</th>
      <th>Type</th>
      <% if @t12n_count > 0 %><th></th><% end %>
      <th></th>
    </tr>
  </thead>
  <tbody>
  <%- @fields.each do |field| -%>
    <tr>
      <td><%= field.name %></td>
      <td><%= field.db_type %></td>
      <%- if @t12n_count > 0 -%>
        <%- if field.transformations_dataset.count > 0 -%>
          <%- list = "<ul>" + field.transformations.inject("") { |s, t| s + "<li>#{t.transformer.name}</li>" } + "</ul>" %>
          <td>
            <a href="#" onclick="transformationsFor('<%= field.name %>');"><img class="tooltip" src="/images/cog.png" title="Transformations - <%= list %>" alt="Cog" /></a>
          </td>
        <%- else -%>
        <td></td>
        <%- end -%>
      <%- end -%>
      <td>
        <a href="#" onclick="newTransformation('<%= field.name %>', <%= field.id %>);"><img class="tooltip" src="/images/hammer.png" title="New Transformation - <%= field.name %>" alt="Hammer" /></a>
      </td>
    </tr>
  <%- end -%>
  </tbody>
</table>
<p>
  <a href="/projects/<%= @project.id %>/resources/<%= @resource.id %>/edit">Select Fields</a>
  <%- if @t12n_count > 0 -%>
  | <a href="/projects/<%= @project.id %>/resources/<%= @resource.id %>/transformations">All Transformations</a>
  <%- end -%>
</p>

<h2>Status</h2>
<div class="section">
<% if !@running_jobs.empty? %>
  <p>This resource is currently being transformed:</p>
  <%= erb(:'jobs/list', {:layout => false}, {:jobs => @running_jobs}) %>
<% elsif !@scheduled_jobs.empty? %>
  <p>This scenario is currently scheduled to be transformed:</p>
  <%= erb(:'jobs/list', {:layout => false}, {:jobs => @scheduled_jobs}) %>
<% else %>
  <p>
    Status: <strong><%= humanize(@resource.status) %></strong><br/>
    <% if @t12n_count > 0 %>
    Last transformed at: <strong><%= @resource.transformed_at || "Never" %></strong>
    <% end %>
  </p>
  <% if @t12n_count > 0 %>
  <form method="get" action="/projects/<%= @project.id %>/resources/<%= @resource.id %>/transform">
    <p>
      <input onclick="return confirm('Are you sure you want to transform this resource?');" value="Transform now" type="submit" />
    </p>
  </form>
  <% end %>
<% end %>
</div>

<% if !@scenarios.empty? %>
<h2>Related Scenarios</h2>
<div class="section">
  <%= erb(:"scenarios/list", :layout => false) %>
</div>
<% end %>

<div id="new_transformation" style="display: none">
  <form method="post" action="/projects/<%= @project.id %>/resources/<%= @resource.id %>/transformations">
    <table class="form">
      <tr>
        <td class="col1"><strong>Field</strong></td>
        <td id="field_id_label" class="col2"></td>
      </tr>
      <tr>
        <td class="col1"><label for="transformer_id" class="strong">Transformer</label></td>
        <td class="col2">
          <select id="transformer_id" name="transformation[transformer_id]">
            <% @transformers.each do |transformer| %>
              <option value="<%= transformer.id %>"><%= transformer.name %></option>
            <% end %>
          </select>
        </td>
      </tr>
    </table>
    <div style="display: none;">
      <input id="field_id_input" name="transformation[field_id]" type="hidden" value="" />
    </div>
  </form>
</div>

<div id="transformations_for" style="display: none">
</div>

<script type="text/javascript">
  function newTransformation(field_name, field_id) {
    $('#field_id_input').val(field_id);
    $('#field_id_label').html(field_name);
    $('#new_transformation').dialog('option', 'title', 'New Transformation').dialog('open');
    return false;
  }
  function transformationsFor(field) {
    $('#transformations_for').load("/projects/<%= @project.id %>/resources/<%= @resource.id %>/transformations/for/" + field, function() {
      $(this).dialog('option', 'title', 'Transformations for '+field).dialog('open');
    });
  }

  var oTable;
  $(function() {
    oTable = $('#fields').dataTable({
      bJQueryUI: true, aaSorting: [],
      aoColumns: [
        null, null,
        <%= "{ bSortable: false, bSearchable: false, sWidth: '20px' }," if @t12n_count > 0 %>
        { bSortable: false, bSearchable: false, sWidth: '20px' }
      ],
    });
    $('.tooltip').tooltip({ delay: 0, track: true, showURL: false, showBody: " - " });
    $('#new_transformation').dialog({
      autoOpen: false,
      buttons: {
        'Create': function() { $('#new_transformation form').submit(); },
        'Cancel': function() { $('#new_transformation').dialog('close'); }
      },
      modal: true,
    });
    $('#transformations_for').dialog({ autoOpen: false });
  });
</script>
