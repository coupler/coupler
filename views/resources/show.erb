<% @breadcrumbs = [@project, @resource] %>
<% add_javascript("jquery-ui.min.js") %>
<% add_stylesheet("jquery-ui.css") %>
<% if flash[:newly_created] %>
<div id="notice">
  Resource successfully created!  Next, if you want to change this resource's fields, you'll need to add transformations.
</div>
<% end %>

<h2>Source Fields</h2>
<div class="section">
  <table class="list">
    <thead>
      <tr>
        <th>Field</th>
        <th>Type</th>
      </tr>
    </thead>
    <tbody>
      <% @resource.source_schema.each do |(column_name, info)| %>
        <tr>
          <td><%= column_name %></td>
          <td><%= info[:db_type] %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<h2>Transformations</h2>
<div class="section">
  <% if @transformations.empty? %>
  <p>
    There are currently no transformations for this resource.
  </p>
  <% else %>
  <%= erb(:"transformations/list", :layout => false) %>
  <% end %>
  <p>
    <a href="/projects/<%= @project.id %>/resources/<%= @resource.id %>/transformations/new">Add transformation</a>
  </p>
</div>

<% if !@transformations.empty? %>
<h3>Transform</h3>
<div class="section">
  <p>
    Status: <strong><%= humanize(@resource.status) %></strong><br/>
    Last transformed at: <strong><%= @resource.transformed_at || "Never" %></strong>
  </p>
  <p>
    <input id="transform-button" type="button" value="Transform Now" />
  </p>
</div>

<div id="transform-dialog">
  <div id="transform-1">
    <form method="get" action="/projects/<%= @project.id %>/resources/<%= @resource.id %>">
      <p>
        This may take a while.  Make sure you have your transformations set up
        correctly.  Do you want to proceed?
      </p>
      <div style="text-align: center">
        <input id="transform-ok-button" type="button" value="Yes" />
        <input id="transform-cancel-button" type="button" value="No" />
      </div>
    </form>
  </div>
  <div id="transform-2" style="display: none;">
    Transforming...
    <div id="progressbar"></div>
  </div>
</div>

<script type="text/javascript">
$(function() {
  dialog = $('#transform-dialog');
  dialog.dialog({
    autoOpen: false, title: "Transform", modal: true
  });
  $('#transform-button').click(function() { dialog.dialog('open'); });
  $('#transform-cancel-button').click(function() { dialog.dialog('close'); });

  urlPrefix = "/projects/<%= @project.id %>/resources/<%= @resource.id %>";
  $('#transform-ok-button').click(function() {
    $.get(urlPrefix+"/transform", function() {
      bar = $('#progressbar');
      bar.progressbar();
      $('#transform-1').hide();
      $('#transform-2').show();

      setInterval(function() {
        $.get(urlPrefix+"/progress", function(percent) {
          bar.progressbar('option', 'value', percent);
          if (percent == 100) {
            window.location.href = urlPrefix;
          }
        }, "json");
      }, 1000);
    });
  });
});
</script>
<% end %>
